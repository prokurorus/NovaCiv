# Архитектурный аудит NovaCiv Video Worker

## Дата: 2024

## 1. Текущая архитектура

### 1.1. Компоненты системы

- **server/video-worker.js** - фоновый воркер для отдельного сервера (PM2)
- **netlify/functions/video-worker.js** - Netlify функция (cron каждые 15 минут)
- **server/youtube.js** - модуль загрузки видео на YouTube
- **media/scripts/pipeline.js** - универсальный конвейер генерации видео

### 1.2. Поток данных

```
Firebase (videoJobs) → video-worker → pipeline → Telegram/YouTube
```

## 2. Критические проблемы и анти-паттерны

### 2.1. ❌ Feature flags через env переменные

**Проблема:**
- `YOUTUBE_UPLOAD_ENABLED` управляется через `.env` файл
- Требует ручного редактирования файла и перезапуска PM2
- Невозможно изменить настройку без доступа к серверу
- Нет централизованного управления

**Код:**
```javascript
// server/video-worker.js:156
if (process.env.YOUTUBE_UPLOAD_ENABLED === "true") {
  // ...
}
```

**Последствия:**
- Невозможно быстро включить/выключить YouTube без SSH доступа
- Риск ошибок при ручном редактировании .env
- Нет истории изменений настроек

### 2.2. ❌ PM2 скрипты редактируют .env

**Проблема:**
- `restart-pm2-video-worker.sh` и `restart-video-worker.sh` используют `sed` для изменения `.env`
- Логика управления фичами смешана с логикой деплоя
- Хрупкая архитектура: скрипт может сломать .env файл

**Код:**
```bash
# restart-pm2-video-worker.sh:14
sed -i 's/^YOUTUBE_UPLOAD_ENABLED=.*/YOUTUBE_UPLOAD_ENABLED=false/' "$ENV_FILE"
```

**Последствия:**
- Нарушение принципа разделения ответственности
- Невозможно безопасно перезапустить воркер без изменения конфигурации
- Сложно отследить, кто и когда изменил настройки

### 2.3. ❌ Дублирование логики

**Проблема:**
- `server/video-worker.js` и `netlify/functions/video-worker.js` имеют похожую логику
- Разная обработка ошибок
- Разная структура кода
- Сложно поддерживать синхронизацию

**Последствия:**
- Баги могут быть исправлены только в одном месте
- Увеличение технического долга
- Сложность тестирования

### 2.4. ❌ Отсутствие централизованной конфигурации

**Проблема:**
- Настройки разбросаны по env переменным
- Нет единого места для управления конфигурацией
- Невозможно динамически изменять поведение системы

### 2.5. ⚠️ Отсутствие googleapis в package.json

**Проблема:**
- `server/youtube.js` использует `googleapis`, но пакет не указан в `package.json`
- Может привести к ошибкам при установке зависимостей

## 3. Предлагаемая архитектура

### 3.1. Принципы

1. **Feature flags ТОЛЬКО в Firebase**
   - Все настройки функций хранятся в `config/features/`
   - Изменения применяются без перезапуска
   - История изменений через Firebase

2. **env ТОЛЬКО для секретов**
   - Токены API (OpenAI, Telegram, YouTube OAuth)
   - Service Account JSON
   - Никакой логики включения/выключения функций

3. **Чистая архитектура**
   - Разделение ответственности
   - Централизованная конфигурация
   - Единая точка управления

### 3.2. Структура Firebase

```
config/
  features/
    youtubeUploadEnabled: boolean
    telegramEnabled: boolean
  settings/
    youtubePrivacyStatus: "public" | "unlisted" | "private"
    youtubeDefaultTags: string[]
```

### 3.3. Новая структура кода

```
server/
  video-worker.js          # Основной воркер (PM2)
  youtube.js               # YouTube модуль (без изменений логики)
  config/
    firebase-config.js     # Инициализация Firebase
    feature-flags.js       # Чтение feature flags из Firebase
```

### 3.4. Обновленные скрипты

- `restart-pm2-video-worker.sh` - только перезапуск, без изменения .env
- Удаление логики редактирования .env

## 4. План миграции

1. ✅ Создать структуру конфигурации в Firebase
2. ✅ Переписать `video-worker.js` с чтением feature flags из Firebase
3. ✅ Обновить скрипты PM2 (убрать редактирование .env)
4. ✅ Добавить `googleapis` в `package.json`
5. ✅ Создать документацию по новой архитектуре

## 5. Преимущества новой архитектуры

- ✅ Динамическое управление функциями без перезапуска
- ✅ Централизованная конфигурация
- ✅ История изменений в Firebase
- ✅ Безопасность: секреты отделены от логики
- ✅ Масштабируемость: легко добавлять новые feature flags
- ✅ Чистота кода: разделение ответственности



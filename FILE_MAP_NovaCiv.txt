NovaCiv Project Map & Architecture
==================================
(Обновлено: 29.11.2025)

Назначение файла
----------------
Этот файл — "память проекта" для ИИ-ассистента.

Задачи:
- Быстро понять, какие файлы и директории уже существуют.
- Видеть общую архитектуру: фронтенд, функции Netlify, Firebase, Telegram.
- Понимать основные потоки данных (новости, форум, домовой, счётчики).
- При добавлении новых файлов/разделов — обновлять эту карту.

Использование:
- Перед серьёзными изменениями пользователь загружает этот файл в чат.
- Ассистент по нему выбирает, какие конкретные файлы попросить для просмотра.


------------------------------------------------------------
1. Стек и общая логика
------------------------------------------------------------

Фронтенд:
- React + TypeScript
- Vite (bundler)
- Tailwind CSS + shadcn/ui
- Многоязычность (RU/EN/DE/ES) через контекст и статические файлы.

Бэкенд (serverless):
- Netlify Functions (`netlify/functions/*.js`)
- Используют:
  - OpenAI API (чат, TTS/ASR, аналитика новостей)
  - Firebase Realtime Database
  - Telegram Bot API
  - SendGrid API (email)

Данные:
- Firebase Realtime Database:
  - форум (темы, ответы),
  - счётчики "Supporters / Joined / Likes",
  - метаданные новостей (обработанные RSS-элементы),
  - возможно, лог домового.

Интеграции:
- Telegram каналы (через бота)
- Email (через SendGrid)
- Новостной RSS (сейчас BBC World)


------------------------------------------------------------
2. Структура файлов (краткий список)
------------------------------------------------------------

Root directory (корень)
-----------------------
  - .gitignore
  - README.md
  - components.json
  - eslint.config.js
  - index.html
  - netlify.toml
  - package-lock.json
  - package.json
  - postcss.config.cjs
  - run_novaciv.bat
  - start_server.bat
  - tailwind.config.ts
  - tsconfig.app.json
  - tsconfig.json
  - tsconfig.node.json
  - vite.config.ts
  - FILE_MAP_NovaCiv.txt   ← ЭТОТ ФАЙЛ

netlify/functions/  (serverless-функции)
----------------------------------------
  - ai-domovoy.js        — ИИ-домовой (чат-ассистент сайта)
  - ai-voice.js          — голосовой ассистент (TTS/voice-интерфейс)
  - fetch-news.js        — новостной движок NovaCiv (RSS → анализ → Firebase → Telegram)
  - post-to-telegram.js  — отправка сообщений в Telegram
  - send-email.js        — отправка писем (форма обратной связи) через SendGrid

public/  (статические ресурсы)
------------------------------
  - _redirects
  - favicon.ico
  - manifest.json
  - og-image.png
  - placeholder.svg
  - robots.txt
  - sitemap.xml
  + lovable-uploads/
      - android.png      — иллюстрация андроида для дизайна сайта

src/  (исходный код фронтенда)
------------------------------
  - App.css
  - App.tsx              — главный React-компонент, роутинг страниц
  - index.css
  - main.tsx             — точка входа React-приложения
  - vite-env.d.ts

  + components/
      - AssistantWidget.tsx     — виджет домового на страницах
      - Header.tsx              — шапка/хедер сайта
      - LanguageSwitcher.tsx    — переключатель языков (RU/EN/DE/ES)
      - SupporterCounter.tsx    — блок счётчиков на странице Join/движения
      - TopNav.tsx              — верхнее меню/навигация по страницам
      + ui/                     — библиотека визуальных компонентов (shadcn/ui)
          - button.tsx
          - card.tsx
          - dialog.tsx
          - input.tsx
          - textarea.tsx
          - tabs.tsx
          - table.tsx
          - ... (остальные UI-блоки, часть может не использоваться прямо сейчас, но полезна на будущее)

  + context/
      - LanguageContext.tsx     — глобальный контекст языка, хранит текущий язык и даёт t()/переводы

  + data/
      - manifesto_de.txt
      - manifesto_en.txt
      - manifesto_es.txt
      - manifesto_ru.txt        — тексты манифеста на разных языках, используются на страницах Manifesto-*.tsx
      - translations.ts         — словарь переводов интерфейса и текстов по языкам

  + hooks/
      - use-mobile.tsx          — хук для определения мобильного устройства/адаптации
      - use-toast.ts            — обёртка для системы тостов (уведомлений)
      - useChat.ts              — логика работы чат-помощника (фронтовая часть)
      - useMember.ts            — логика регистрации/учёта участника (если используется)
      - useStats.ts             — работа со статистикой/счётчиками (подтягивает данные через Firebase/lib)

  + lib/
      - counters.ts             — функции работы со счётчиками (поддержка, лайки, присоединения)
      - firebase.ts             — инициализация и вспомогательные функции для работы с Firebase
      - utils.ts                — общие утилиты (форматирование, вспомогательные функции, вызовы функций Netlify)

  + pages/
      - Charter-de.tsx
      - Charter-en.tsx
      - Charter-es.tsx
      - Charter-ru.tsx
      - Charter.tsx             — страницы Устава на разных языках + общий роутер
      - ForumPage.tsx           — страница списка тем форума
      - Home.tsx                — домашняя страница (главный экран/landing)
      - Index.tsx               — обертка/альтернативная точка входа (используется в маршрутизации)
      - Join.tsx                — страница «Присоединиться», счётчики и кнопки
      - Manifesto-de.tsx
      - Manifesto-en.tsx
      - Manifesto-es.tsx
      - Manifesto-ru.tsx
      - Manifesto.tsx           — страницы Манифеста + общий роутер
      - News.tsx                — страница ленты NovaCiv Movement / Movement News
      - NotFound.tsx            — 404-страница
      - TopicPage.tsx           — страница отображения конкретной темы форума
      - Vision.tsx              — страница «Наше видение»/описание NovaCiv

  + types/
      - language.ts             — типы для языков/локалей

  + utils/
      (на текущий момент отсутствуют значимые файлы или папка не используется —
       ранее был рудимент `postToTelegram.ts`, он удалён)


------------------------------------------------------------
3. Основные потоки данных (data flows)
------------------------------------------------------------

3.1. Новости NovaCiv (News Engine)
----------------------------------

Задача:
- Автоматически брать новости из RSS (BBC World),
- Генерировать осмысленный обзор в духе NovaCiv,
- Сохранять в Firebase,
- Отображать на странице News.tsx,
- Отправлять в Telegram-канал.

Участники:
- `netlify/functions/fetch-news.js`
- `netlify/functions/post-to-telegram.js`
- `src/pages/News.tsx`
- `src/lib/firebase.ts`
- Firebase Realtime Database
- Telegram Bot API
- OpenAI Chat API

Примерный поток:

1) Вызов функции:
   - вручную: GET `/.netlify/functions/fetch-news?token=NEWS_CRON_SECRET`
   - в будущем: cron/автоматический триггер.

2) `fetch-news.js`:
   - читает RSS (например, BBC World), парсит `<item>`:
     - `title`, `link`, `description`, `pubDate`, `guid`, `sourceId`.
   - проверяет, какие новости уже обработаны:
     - по ключам в Firebase (ветка вида `/newsMeta/en` или аналог),
     - по заголовкам/ссылкам (чтобы не было дублей).
   - выбирает до `MAX_NEW_ITEMS_PER_RUN` свежих элементов.
   - для каждого элемента вызывает OpenAI:
     - системный промпт — ценности NovaCiv,
     - user-промпт — текст новости.
   - получает структурированный текст:
     - краткое содержание,
     - почему важно,
     - взгляд NovaCiv,
     - вопрос к читателю.

3) Сохранение:
   - запись новости в Firebase, в раздел форума (например, `forum/topics` с `section: "news"`).
   - обновление метаданных (какие ключи уже обработаны).

4) Отправка в Telegram:
   - `fetch-news.js` формирует текст поста,
   - вызывает `post-to-telegram.js` (или сам Telegram API),
   - пост улетает в канал (используются `TELEGRAM_BOT_TOKEN` и `TELEGRAM_NEWS_CHAT_ID`).

5) Фронтенд:
   - `News.tsx` через `firebase.ts`/`useStats` или собственный код читает темы `section === "news"`,
   - отображает ленту «Movement news / NovaCiv movement feed».

Важно:
- Источник истины — Firebase: что уже сохранено, то считается обработанным.
- Дубликаты должны отсекаться по ключам (link/guid/title) и/или по мета-ветке `newsMeta`.


3.2. Форум (темы и ответы)
---------------------------

Задача:
- Позволять пользователям просматривать темы проекта и ответы,
- В перспективе — создавать и комментировать (когда будет UI).

Участники:
- `src/pages/ForumPage.tsx`
- `src/pages/TopicPage.tsx`
- `src/lib/firebase.ts`
- `src/hooks/useStats.ts` (возможна часть логики)
- Firebase Realtime Database

Примерный поток (ожидаемый):
- Темы хранятся в ветке вида: `/forum/topics`.
  - поля: `title`, `content`, `createdAt`, `authorNickname`, `section`, `lang`, etc.
- Ответы/комментарии — в ветке `/forum/replies` или аналог (в зависимости от реализации).
- `ForumPage.tsx`:
  - читает список тем,
  - фильтрует по `section` (например, "general", "news", "announcements") и по языку.
- `TopicPage.tsx`:
  - читает одну тему по `topicId`,
  - подгружает ответы к этой теме.

Точные пути и поля лучше иногда сверять по содержимому `ForumPage.tsx` и `TopicPage.tsx`, если есть сомнения.


3.3. Страница Join (счётчики и кнопки)
--------------------------------------

Задача:
- Показывать живую статистику:
  - сколько людей присоединились,
  - сколько поддержали,
  - возможно, другие метрики.
- Давать кнопки: "Присоединяюсь", "Мне нравится" и т.п.

Участники:
- `src/pages/Join.tsx`
- `src/components/SupporterCounter.tsx`
- `src/hooks/useStats.ts`
- `src/lib/counters.ts`
- `src/lib/firebase.ts`
- Firebase Realtime Database

Поток:

1) При рендере страницы `Join.tsx`:
   - через `SupporterCounter` и `useStats` считываются текущие значения из Firebase (ветка вида `/stats` или `/counters`).

2) При нажатии на кнопки:
   - вызываются функции из `counters.ts`:
     - например, `incrementJoined()`, `incrementLiked()`.
   - эти функции обновляют значения в Firebase.

3) UI:
   - `SupporterCounter` подписан на изменения/обновления (через хук или одноразовый fetch),
   - показывает актуальные цифры.

В будущем эти же данные могут использоваться:
- на главной,
- в отчётности,
- как аргумент "движение живое".


3.4. Домовой (чат-ассистент на сайте)
-------------------------------------

Задача:
- Общаться с посетителями,
- Знать: Устав, Манифест, структуру сайта,
- Помогать навигации, отвечать на вопросы, собирать обратную связь.

Участники:
- `src/components/AssistantWidget.tsx`
- `src/hooks/useChat.ts`
- `src/context/LanguageContext.tsx`
- `netlify/functions/ai-domovoy.js`
- `src/lib/firebase.ts` (опционально, для логов/контекста)
- OpenAI Chat API

Поток:

1) Пользователь пишет сообщение в `AssistantWidget`.
2) `useChat` формирует запрос:
   - текст пользователя,
   - текущий язык (RU/EN/DE/ES),
   - возможно, тип запроса (help/navigation/feedback).
3) Запрос отправляется на `/.netlify/functions/ai-domovoy`.
4) `ai-domovoy.js`:
   - формирует системный промпт с ценностями NovaCiv + знанием структуры сайта,
   - добавляет сообщение пользователя,
   - вызывает OpenAI (chat.completions),
   - при необходимости может:
     - читать из Firebase (форум, счётчики, новости),
     - сохранять историю/логи.
5) Ответ возвращается на фронт и отображается в виджете.

В будущем:
- расширение памяти домового,
- отдельные режимы — "спросить про Устав", "спросить про движение", "техподдержка".


3.5. Голосовой ассистент
-------------------------

Задача:
- Позволить задавать вопросы голосом и получать голосовой ответ.

Участники:
- `netlify/functions/ai-voice.js`
- OpenAI TTS / ASR
- фронтенд-код (компоненты, используя микрофон/аудио-плеер)

Поток (общая логика):
- фронтенд записывает голос → отправляет аудио или текст на `ai-voice.js`,
- `ai-voice.js`:
  - если аудио — распознаёт речь (ASR),
  - передаёт текст в OpenAI для ответа (как домовой),
  - генерирует голосовой ответ (TTS),
  - возвращает URL или бинарный аудио-поток.
- фронтенд воспроизводит ответ.


3.6. Email/контактная форма
----------------------------

Задача:
- Дать людям возможность написать основателю/команде с сайта.

Участники:
- Форма на одной из страниц (возможно, Join/Contact/Forum)
- `netlify/functions/send-email.js`
- SendGrid API

Поток:
- Форма фронтенда отправляет данные на `/.netlify/functions/send-email`.
- `send-email.js`:
  - формирует письмо,
  - отправляет через SendGrid на указанный e-mail.
- В будущем можно сохранять копии в Firebase (лог обращений).


------------------------------------------------------------
4. Языки и переводы
------------------------------------------------------------

Участники:
- `src/context/LanguageContext.tsx`       — хранит текущий язык и методы переключения.
- `src/components/LanguageSwitcher.tsx`   — UI-переключатель языков.
- `src/data/translations.ts`              — словарь строк интерфейса.
- `src/data/manifesto_*.txt`              — длинные текстовые блоки Манифеста.
- `src/pages/Manifesto-*.tsx`             — подгружают соответствующие тексты.
- `src/pages/Charter-*.tsx`               — показывают Устав на разных языках.

Принцип:
- Базовые интерфейсные строки (заголовки, подписи, кнопки) — через `translations.ts`.
- Крупные тексты (Манифест, Устав) — отдельные страницы/файлы на каждом языке.
- Язык сохраняется в контексте, возможно в localStorage (зависит от реализации в `LanguageContext.tsx`).


------------------------------------------------------------
5. Рекомендации по обновлению карты
------------------------------------------------------------

При добавлении новых элементов:

1) **Новая страница**
   - Файл в `src/pages/` (например, `Drivers.tsx`).
   - Добавить строку в раздел `src/pages/` в этом файле.
   - Если есть новая логика (hook/lib) — также указать в `hooks/` или `lib/`.

2) **Новая функция Netlify**
   - Файл в `netlify/functions/` (например, `drivers-email.js`).
   - Добавить строку с описанием в раздел `netlify/functions/`.
   - Если использует новые env-переменные — кратко отметить (см. ниже).

3) **Новая интеграция (API, сервис)**
   - Указать, в каком файле настройка (lib/… или netlify/functions/…),
   - Какие env-переменные используются.

4) **Удаление старых файлов**
   - После физического удаления файла из проекта — убрать его из этой карты,
   - Отметить, если что-то было архивировано или заменено.

Так файл остаётся живым отражением архитектуры и предотвращает путаницу.


------------------------------------------------------------
6. Переменные окружения (Netlify/Firebase/OpenAI/Telegram)
------------------------------------------------------------

(Краткая памятка, без конкретных значений)

Используются переменные (названия могут уточняться в коде):

- Firebase:
  - FIREBASE_DB_URL или похожий (URL Realtime Database)
  - Дополнительно в `firebase.ts` — ключи проекта (apiKey, authDomain, etc.)

- OpenAI:
  - OPENAI_API_KEY
  - OPENAI_MODEL (опционально, например "gpt-4o-mini")
  - OPENAI_TTS_MODEL (для ai-voice.js)

- Telegram:
  - TELEGRAM_BOT_TOKEN
  - TELEGRAM_CHAT_ID           — общий/тестовый
  - TELEGRAM_NEWS_CHAT_ID      — канал новостей (EN)
  - (в будущем) TELEGRAM_NEWS_CHAT_ID_RU, TELEGRAM_NEWS_CHAT_ID_DE и т.д.

- NovaCiv news engine:
  - NEWS_CRON_SECRET           — секрет для защиты вызова `fetch-news`

- Email:
  - SENDGRID_API_KEY           — для send-email.js
  - EMAIL_TO / EMAIL_FROM      — может быть в коде или в переменных окружения.


============================================================
Конец файла.
При изменении архитектуры / добавлении модулей — обновить.
============================================================

# Отчет о настройке инфраструктуры NovaCiv

## Дата выполнения
2024-12-19

## Выполненные задачи

### 1. ✅ Установка и настройка Grafana и Prometheus

#### Созданные файлы:
- `monitoring/prometheus/prometheus.yml` - конфигурация Prometheus
- `monitoring/grafana/provisioning/datasources/prometheus.yml` - настройка источника данных
- `monitoring/grafana/provisioning/dashboards/dashboard.yml` - настройка дашбордов
- `monitoring/grafana/dashboards/pm2-overview.json` - дашборд для мониторинга PM2
- `scripts/install-monitoring.sh` - скрипт автоматической установки

#### Функциональность:
- **Prometheus** настроен для сбора метрик с:
  - PM2 процессов (через PM2 Exporter на порту 9615)
  - Системных метрик (через Node Exporter на порту 9100)
  - Собственных метрик Prometheus (порт 9090)

- **Grafana** настроена для визуализации:
  - Автоматическая настройка Prometheus как источника данных
  - Готовый дашборд для мониторинга PM2 процессов
  - Метрики CPU, памяти, диска, перезапусков

#### Инструкции по установке:
См. подробную документацию в `docs/MONITORING_SETUP.md`

**Команда для установки на VPS:**
```bash
ssh root@77.42.36.198 "bash -s" < scripts/install-monitoring.sh
```

**Доступ:**
- Prometheus: `http://<VPS_IP>:9090` (или через SSH туннель)
- Grafana: `http://<VPS_IP>:3000` (логин: admin, пароль: admin - изменить!)

### 2. ✅ Создание инструмента для управления задачами

#### Созданные файлы:
- `docs/TASK_MANAGEMENT_SETUP.md` - полная документация по настройке

#### Рекомендации:
- **Trello** - рекомендуется для проекта NovaCiv (простота, бесплатный план)
- **Jira** - альтернатива для больших команд

#### Документация включает:
- Пошаговую настройку Trello
- Структуру досок и колонок
- Интеграцию с GitHub
- Best practices
- Рекомендации по меткам и приоритетам

#### Следующие шаги:
1. Создать доску Trello "NovaCiv Development"
2. Настроить колонки (Backlog, To Do, In Progress, Review, Done)
3. Интегрировать с GitHub через Power-Up
4. Настроить автоматизацию через Butler

### 3. ✅ Настройка CI/CD с GitHub Actions

#### Созданные файлы:
- `.github/workflows/deploy.yml` - workflow для автоматического деплоя

#### Функциональность:
- **Тестирование и линтинг:**
  - Автоматический запуск при push в main и PR
  - Проверка кода через `npm run lint`
  - Сборка проекта для проверки ошибок

- **Автоматический деплой:**
  - Деплой на VPS только после успешных тестов
  - Деплой только при push в main ветку
  - Автоматический pull, установка зависимостей, перезапуск PM2
  - Проверка статуса после деплоя

#### Требуемые секреты GitHub:
- `VPS_SSH_PRIVATE_KEY` - приватный SSH ключ для доступа к VPS
- `VPS_HOST` - IP адрес или домен VPS (77.42.36.198)
- `VPS_USER` - пользователь для SSH (root)

#### Настройка:
1. Перейти в Settings → Secrets and variables → Actions
2. Добавить секреты:
   - `VPS_SSH_PRIVATE_KEY`: содержимое приватного ключа
   - `VPS_HOST`: 77.42.36.198
   - `VPS_USER`: root

#### Использование:
- Автоматический деплой при каждом push в main
- Ручной запуск через "Run workflow" в GitHub Actions
- Просмотр статуса деплоя в Actions tab

### 4. ✅ Внедрение инструментов аналитики

#### Созданные файлы:
- `src/lib/analytics.ts` - модуль для работы с Google Analytics
- Обновлен `src/main.tsx` - инициализация Google Analytics
- Обновлен `src/App.tsx` - отслеживание просмотров страниц
- Обновлен `src/components/LanguageSwitcher.tsx` - отслеживание переключения языков

#### Функциональность:
- **Инициализация Google Analytics:**
  - Автоматическая загрузка gtag.js
  - Работает только в production режиме
  - Настраивается через переменную окружения `VITE_GA_MEASUREMENT_ID`

- **Отслеживание событий:**
  - Просмотры страниц (автоматически)
  - Переключение языков
  - Просмотр контента (Charter, Manifesto)
  - Переходы на страницы (News, Forum, Join)

#### Настройка:
1. Создать Google Analytics property для novaciv.space
2. Получить Measurement ID (формат: G-XXXXXXXXXX)
3. Добавить в `.env`:
   ```
   VITE_GA_MEASUREMENT_ID=G-XXXXXXXXXX
   ```
4. Пересобрать проект: `npm run build`

#### Доступные события:
- `page_view` - автоматически при смене страницы
- `language_switch` - при переключении языка
- `charter_view` - просмотр устава (можно добавить)
- `manifest_view` - просмотр манифеста (можно добавить)
- `news_view` - просмотр новостей (можно добавить)
- `forum_view` - просмотр форума (можно добавить)
- `join_click` - клик на кнопку присоединения (можно добавить)

**Примечание:** Plausible Analytics уже настроен в `index.html`. Google Analytics добавлен как дополнительный инструмент.

### 5. ✅ Оптимизация процессов

#### Созданные файлы:
- `docs/OPTIMIZATION_ANALYSIS.md` - полный анализ и рекомендации

#### Выявленные узкие места:
1. ✅ **Деплоймент** - решено через CI/CD
2. ✅ **Мониторинг** - решено через Prometheus + Grafana
3. ⚠️ **Обработка ошибок** - требуется централизованное логирование
4. ⚠️ **Тестирование** - требуется добавить автоматические тесты
5. ⚠️ **Производительность видео-воркера** - можно оптимизировать через очередь
6. ⚠️ **Резервное копирование** - требуется настроить автоматические бэкапы

#### Рекомендации по приоритетам:

**Краткосрочные (1-2 недели):**
1. Настроить алерты в Grafana (High)
2. Добавить базовые тесты (Medium)
3. Улучшить логирование (Medium)

**Среднесрочные (1-2 месяца):**
1. Внедрить очередь задач (Medium)
2. Настроить резервное копирование (High)
3. Оптимизация производительности (Low)

**Долгосрочные (3+ месяца):**
1. Микросервисная архитектура (Low)
2. Kubernetes миграция (Low)

## Структура созданных файлов

```
NovaCiv/
├── .github/
│   └── workflows/
│       └── deploy.yml                    # CI/CD workflow
├── monitoring/
│   ├── prometheus/
│   │   └── prometheus.yml                # Конфигурация Prometheus
│   └── grafana/
│       ├── provisioning/
│       │   ├── datasources/
│       │   │   └── prometheus.yml        # Настройка источника данных
│       │   └── dashboards/
│       │       └── dashboard.yml         # Настройка дашбордов
│       └── dashboards/
│           └── pm2-overview.json         # Дашборд PM2
├── scripts/
│   └── install-monitoring.sh             # Скрипт установки мониторинга
├── src/
│   ├── lib/
│   │   └── analytics.ts                  # Google Analytics модуль
│   ├── main.tsx                          # Обновлен: инициализация GA
│   ├── App.tsx                           # Обновлен: отслеживание страниц
│   └── components/
│       └── LanguageSwitcher.tsx          # Обновлен: отслеживание языков
└── docs/
    ├── MONITORING_SETUP.md               # Документация по мониторингу
    ├── TASK_MANAGEMENT_SETUP.md          # Документация по Trello/Jira
    ├── OPTIMIZATION_ANALYSIS.md          # Анализ и рекомендации
    └── INFRASTRUCTURE_SETUP_REPORT.md    # Этот отчет
```

## Следующие шаги

### Немедленные действия:

1. **Настроить GitHub Secrets:**
   - Перейти в Settings → Secrets → Actions
   - Добавить `VPS_SSH_PRIVATE_KEY`, `VPS_HOST`, `VPS_USER`

2. **Установить мониторинг на VPS:**
   ```bash
   ssh root@77.42.36.198 "bash -s" < scripts/install-monitoring.sh
   ```

3. **Настроить Google Analytics:**
   - Создать property в Google Analytics
   - Добавить `VITE_GA_MEASUREMENT_ID` в `.env`
   - Пересобрать проект

4. **Создать доску Trello:**
   - Следовать инструкциям в `docs/TASK_MANAGEMENT_SETUP.md`

### Краткосрочные задачи:

1. Настроить алерты в Grafana
2. Добавить базовые тесты
3. Улучшить логирование

## Возможные проблемы и решения

### Проблема: CI/CD не работает

**Причины:**
- Не настроены GitHub Secrets
- Неправильный SSH ключ
- Проблемы с доступом к VPS

**Решение:**
- Проверить настройку секретов
- Проверить SSH подключение вручную
- Проверить логи в GitHub Actions

### Проблема: Prometheus не собирает метрики

**Причины:**
- PM2 Exporter не запущен
- Неправильная конфигурация
- Проблемы с портами

**Решение:**
- Проверить статус сервисов: `systemctl status pm2-exporter`
- Проверить доступность: `curl http://localhost:9615/metrics`
- Проверить конфигурацию: `promtool check config /etc/prometheus/prometheus.yml`

### Проблема: Google Analytics не работает

**Причины:**
- Не установлен `VITE_GA_MEASUREMENT_ID`
- Работает только в production
- Блокировщики рекламы

**Решение:**
- Проверить переменную окружения
- Проверить в production сборке
- Отключить блокировщики для тестирования

## Заключение

Все основные задачи выполнены:

✅ **Grafana и Prometheus** - настроены и готовы к установке
✅ **Управление задачами** - документация по Trello/Jira создана
✅ **CI/CD** - GitHub Actions workflow создан
✅ **Google Analytics** - интегрирован в приложение
✅ **Оптимизация** - проведен анализ и подготовлены рекомендации

Все изменения задокументированы и готовы к использованию. Следующий шаг - установка компонентов на VPS и настройка секретов в GitHub.

## Контакты и поддержка

При возникновении проблем:
1. Проверьте документацию в папке `docs/`
2. Проверьте логи сервисов
3. Используйте мониторинг для диагностики

---

**Отчет подготовлен:** 2024-12-19
**Версия:** 1.0

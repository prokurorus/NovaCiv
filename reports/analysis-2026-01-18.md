# NovaCiv — аналитический отчет (локальный аудит)

Дата: 2026-01-18  
Источник: локальный репозиторий `C:/NovaCiv/NovaCiv`  
Режим: только анализ, без фиксов

## Объем и источники

Проведена статическая проверка локального репозитория и документации. Использованы:
- `README.md`
- `docs/PROJECT_STATE.md`
- `docs/REPO_MAP.md`
- `docs/health-monitoring.md`
- `runbooks/SOURCE_OF_TRUTH.md`
- `runbooks/deploy_pull_only.sh`
- `runbooks/snapshot_system.sh`
- `netlify.toml`
- `netlify/functions-lite/admin-proxy.js`
- `netlify/functions-lite/health-news.js`
- `netlify/functions-lite/health-domovoy.js`
- `server/ops-agent.js`
- `package.json`

Remote SSH к VPS не использовался (можно применить только для read-only диагностики при необходимости).

## Краткий обзор архитектуры

- **Frontend**: Vite + React (`src/`), статический сайт, деплой через Netlify.
- **Netlify Functions**: в `netlify/functions-lite` оставлены lightweight endpoints (admin-proxy + health).  
  В `netlify.toml` зафиксирован режим "VPS-only" для тяжелых функций.
- **VPS**: основная серверная логика в `server/` под PM2 (ops-agent, video-worker, admin-domovoy).
- **Системный контроль**: snapshot-скрипт (`runbooks/snapshot_system.sh`) с фильтрацией секретов; health endpoints для мониторинга pipelines.
- **Политика Source of Truth**: GitHub main, VPS — pull-only.

## Наблюдения и несоответствия

1) **Документация vs конфигурация Netlify**  
`docs/PROJECT_STATE.md` и `docs/REPO_MAP.md` описывают работающие scheduled Netlify functions (news/domovoy/video),  
но `netlify.toml` явно фиксирует режим "VPS-only" и functions-lite как единственный деплой.  
Риск: операционные команды и мониторинг могут опираться на устаревшую картину окружения.

2) **functions-lite требуют Firebase, но заявлена минимальная env-поверхность**  
`netlify/functions-lite/health-*.js` читают `FIREBASE_DB_URL` и `NEWS_CRON_SECRET`,  
тогда как `netlify.toml` заявляет "минимальный набор env vars" и вынос тяжелых зависимостей на VPS.  
Риск: health endpoints могут быть неработоспособны на Netlify либо вынуждают хранить Firebase env vars в Netlify.

3) **Комментарий о fallback-аутентификации не соответствует коду**  
В `admin-proxy.js` есть комментарий про "role OR token fallback", но `authorizeAdmin()`  
проверяет только Netlify Identity admin role.  
Риск: операторы могут ожидать альтернативный доступ, которого нет.

4) **Ops-agent: заголовочное описание шире текущих возможностей**  
В `server/ops-agent.js` в описании заявлены git операции (commit/push/PR),  
но в whitelist их нет.  
Риск: ожидания не совпадают с реальными возможностями агента.

## Рекомендации (без изменений кода)

- **Синхронизировать документацию с фактическим деплоем**: привести `docs/PROJECT_STATE.md` и `docs/REPO_MAP.md`  
  к текущему режиму `functions-lite` и VPS-only pipeline.
- **Явно описать политику env vars для Netlify**:  
  либо допустить Firebase env vars на Netlify ради health endpoints,  
  либо перенести health endpoints на VPS и обновить docs/runbooks.
- **Уточнить модель доступа в админ-прокси**:  
  привести комментарии и runbooks к реальному поведению (только RBAC через Netlify Identity).
- **Обновить описание ops-agent**:  
  оставить только те операции, которые реально доступны в whitelist.
- **Добавить раздел “Monitoring Reality Check”** в `docs/health-monitoring.md`:  
  явно указать, откуда берутся health метрики (Netlify vs VPS) и где ожидать доступность.

## Предлагаемая read-only диагностика на VPS (если понадобится)

Команды в режиме только чтения:
- `pm2 status`
- `git status --short` и `git rev-parse --short HEAD`
- Проверка snapshot файлов: `ls -l /root/NovaCiv/_state/system_snapshot.*`
- Проверка crontab: `crontab -l | grep snapshot_system.sh`
- Проверка health endpoints через Netlify:  
  `curl "https://novaciv.space/.netlify/functions/health-news?token=..."`  
  `curl "https://novaciv.space/.netlify/functions/health-domovoy?token=..."`

## Вывод

Код и документация показывают зрелый операционный контур (pull-only, snapshot, ops-agent),  
но есть расхождения между реальным конфигом Netlify и описанием в документах.  
Рекомендуется привести документацию и мониторинг к единому источнику истины,  
не меняя код — только актуализируя описание и операционные ожидания.
